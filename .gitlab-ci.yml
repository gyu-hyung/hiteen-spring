stages:
  - build
  - push
  - deploy

# =========================
# 1ï¸âƒ£ ê³µí†µ ë³€ìˆ˜ ì„¤ì •
# =========================
variables:
  DOCKER_IMAGE: $CI_REGISTRY_IMAGE       # GitLab Container Registry ì£¼ì†Œ (ìžë™ ì œê³µë¨)
  IMAGE_TAG: $CI_COMMIT_SHORT_SHA        # ì»¤ë°‹ SHAë¡œ ë²„ì „ ê´€ë¦¬
  CHART_PATH: ./hiteen-chart             # Helm ì°¨íŠ¸ ê²½ë¡œ
  NAMESPACE: hiteen                      # ë°°í¬ ë„¤ìž„ìŠ¤íŽ˜ì´ìŠ¤
  KUBECONFIG_FILE: /tmp/kubeconfig       # K8S ì ‘ì†ìš© config ê²½ë¡œ

# =========================
# 2ï¸âƒ£ Docker ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ
# =========================
build-and-push:
  stage: push
  image: docker:25.0.3
  services:
    - docker:dind
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" "$CI_REGISTRY" --password-stdin
  script:
    - docker build -t $DOCKER_IMAGE:$IMAGE_TAG .
    - docker push $DOCKER_IMAGE:$IMAGE_TAG
  only:
    - main   # main ë¸Œëžœì¹˜ í‘¸ì‹œ ì‹œë§Œ ìžë™ ë¹Œë“œ/ë°°í¬

# =========================
# 3ï¸âƒ£ Helm ë°°í¬ (K8S ìžë™ ë°°í¬)
# =========================
deploy:
  stage: deploy
  image:
    name: alpine/helm:3.14.3
    entrypoint: [""]
  before_script:
    # base64ë¡œ ì¸ì½”ë”©ëœ KUBECONFIG í™˜ê²½ë³€ìˆ˜ë¥¼ íŒŒì¼ë¡œ ë³µì›
    - echo "$KUBECONFIG_BASE64" | base64 -d > $KUBECONFIG_FILE
    - export KUBECONFIG=$KUBECONFIG_FILE
  script:
    - echo "ðŸš€ Helm Deploying version $IMAGE_TAG ..."
    - helm upgrade --install hiteen-api $CHART_PATH -n $NAMESPACE \
      --set image.repository=$DOCKER_IMAGE \
      --set image.tag=$IMAGE_TAG \
      --set image.pullPolicy=Always
  only:
    - main
