# ============================================
# GitLab CI/CD Pipeline for Hiteen
# GitLab Container Registry ÏÇ¨Ïö©
# gitlab.barunsoft.net:5005/jiasoft/hiteen2-server
# ============================================
stages:
  - build-jar
  - build-image
  - deploy-prod

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  GRADLE_OPTS: "-Dorg.gradle.daemon=false"

  # Container Registry (GitLab Registry)
  REGISTRY_IMAGE: gitlab.barunsoft.net:5005/jiasoft/hiteen2-server

  # Kubernetes
  KUBE_NAMESPACE_PROD: hiteen

# ============================================
# Cache Configuration
# ============================================
.gradle-cache: &gradle-cache
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .gradle/
      - build/

# ============================================
# 1. Gradle Build Stage (JAR ÏÉùÏÑ±)
# ============================================
build-jar:
  stage: build-jar
  image: eclipse-temurin:21-jdk
  <<: *gradle-cache
  script:
    - chmod +x ./gradlew
    - ./gradlew clean build -x test --no-daemon
    - ls -la build/libs/
  artifacts:
    paths:
      - build/libs/*.jar
    expire_in: 1 hour
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

# ============================================
# 2. Docker Build & Push Stage
# ============================================
build-image:
  stage: build-image
  image: docker:24-dind
  services:
    - docker:24-dind
  needs:
    - job: build-jar
      artifacts: true
  before_script:
    # GitLab Registry Î°úÍ∑∏Ïù∏
    - echo "$CI_DEPLOY_PASSWORD" | docker login -u "$CI_DEPLOY_USER" --password-stdin gitlab.barunsoft.net:5005
  script:
    - |
      # JAR ÌååÏùº ÌôïÏù∏
      ls -la build/libs/
      
      TAG="prod-${CI_COMMIT_SHORT_SHA}"
      echo "Building image with tag: $TAG"
      
      docker build \
        -t $REGISTRY_IMAGE:$TAG \
        -t $REGISTRY_IMAGE:latest \
        .
      
      docker push $REGISTRY_IMAGE:$TAG
      docker push $REGISTRY_IMAGE:latest
      
      echo "IMAGE_TAG=$TAG" >> build.env
  artifacts:
    reports:
      dotenv: build.env
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

# ============================================
# Deploy to Production (main Î∏åÎûúÏπò)
# ============================================
deploy-prod:
  stage: deploy-prod
  image:
    name: alpine/helm:3.14.0
    entrypoint: [""]
  needs:
    - job: build-image
      artifacts: true
  before_script:
    - apk add --no-cache kubectl curl bash
    - mkdir -p ~/.kube
    - echo "$KUBE_CONFIG_PROD" | base64 -d > ~/.kube/config
    - chmod 600 ~/.kube/config
    # TLS Í≤ÄÏ¶ù Ïä§ÌÇµ (ÎÇ¥Î∂ÄÎßù)
    - kubectl config set-cluster kubernetes --insecure-skip-tls-verify=true
  script:
    - |
      echo "üöÄ Deploying to Production environment"
      echo "Image tag: $IMAGE_TAG"
      echo "Registry: $REGISTRY_IMAGE"
      
      # ÌÅ¥Îü¨Ïä§ÌÑ∞ Ïó∞Í≤∞ ÌôïÏù∏
      kubectl get nodes
      
      # Namespace ÏÉùÏÑ±
      kubectl get ns $KUBE_NAMESPACE_PROD || kubectl create ns $KUBE_NAMESPACE_PROD
      
      # GitLab Registry Secret ÏÉùÏÑ±
      kubectl delete secret gitlab-registry -n $KUBE_NAMESPACE_PROD --ignore-not-found
      kubectl create secret docker-registry gitlab-registry \
        --docker-server=gitlab.barunsoft.net:5005 \
        --docker-username=$CI_DEPLOY_USER \
        --docker-password=$CI_DEPLOY_PASSWORD \
        -n $KUBE_NAMESPACE_PROD
      
      # Firebase Secret ÏÉùÏÑ±
      echo "$FIREBASE_KEY_JSON" | base64 -d > firebase-key.json
      kubectl delete secret firebase-secret -n $KUBE_NAMESPACE_PROD --ignore-not-found
      kubectl create secret generic firebase-secret \
        --from-file=firebase-key.json=firebase-key.json \
        -n $KUBE_NAMESPACE_PROD
      rm -f firebase-key.json
      
      # Redis Secret ÏÉùÏÑ±
      kubectl delete secret redis-secret -n $KUBE_NAMESPACE_PROD --ignore-not-found
      kubectl create secret generic redis-secret \
        --from-literal=redis-password=$REDIS_PASSWORD_PROD \
        -n $KUBE_NAMESPACE_PROD
      kubectl label secret redis-secret -n $KUBE_NAMESPACE_PROD app.kubernetes.io/managed-by=Helm --overwrite
      kubectl annotate secret redis-secret -n $KUBE_NAMESPACE_PROD meta.helm.sh/release-name=hiteen --overwrite
      kubectl annotate secret redis-secret -n $KUBE_NAMESPACE_PROD meta.helm.sh/release-namespace=$KUBE_NAMESPACE_PROD --overwrite
      
      # Helm Î∞∞Ìè¨
      helm upgrade --install hiteen ./hiteen-chart \
        -n $KUBE_NAMESPACE_PROD \
        --set app.image.repository=$REGISTRY_IMAGE \
        --set app.image.tag=$IMAGE_TAG \
        --set app.image.pullSecrets[0].name=gitlab-registry \
        --set app.env=prod \
        --set ingress.enabled=true \
        --set redis.enabled=true \
        --set redis.password=$REDIS_PASSWORD_PROD \
        --set redis.storageClass=local-path \
        --set redis.cluster.enabled=true \
        --wait --timeout 10m
      
      # Î∞∞Ìè¨ ÌôïÏù∏
      kubectl get pods -n $KUBE_NAMESPACE_PROD -o wide
      
      echo "‚úÖ Production deployment completed"
  environment:
    name: production
    url: https://api.hiteen.co.kr
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

