name: ðŸš€ Deploy to Kubernetes (Helm)

on:
  workflow_run:
    workflows: ["ðŸ—ï¸ Build & Push Docker Image"]
    types: [completed]

jobs:
  deploy:
    runs-on: [self-hosted]   # EC2 Runner (ì´ë¯¸ ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„° ì ‘ê·¼ ê°€ëŠ¥)

    env:
      NAMESPACE: hiteen
      CHART_PATH: ./hiteen-chart
      IMAGE: ghcr.io/${{ github.repository_owner }}/hiteen-api
      TAG: ${{ github.event.workflow_run.head_sha }}

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: v1.30.0

      - name: ðŸ§° Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: ðŸ” Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 --decode > ~/.kube/config
          chmod 600 ~/.kube/config
          kubectl config set-cluster kubernetes --insecure-skip-tls-verify=true
          echo "âœ… Current context:"
          kubectl config current-context
          kubectl get nodes -o wide

      - name: ðŸ§± Create namespace if not exists
        run: |
          kubectl get ns $NAMESPACE || kubectl create ns $NAMESPACE

      - name: ðŸ” Create Firebase Secret
        run: |
          echo "${{ secrets.FIREBASE_KEY_JSON }}" | base64 --decode > firebase-key.json
          kubectl delete secret firebase-secret -n $NAMESPACE --ignore-not-found
          kubectl create secret generic firebase-secret \
            --from-file=firebase-key.json=firebase-key.json \
            -n $NAMESPACE
          rm -f firebase-key.json
        shell: bash

      - name: ðŸ§¹ Clean up pending Helm release
        run: |
          if helm status hiteen -n $NAMESPACE | grep -q "pending"; then
            echo "ðŸ”§ Found pending release. Cleaning up..."
            helm uninstall hiteen -n $NAMESPACE || true
          fi

          # âœ… Redis cluster post-install Job ì •ë¦¬ (ì¤‘ë³µ ì—ëŸ¬ ë°©ì§€)
          if kubectl get job redis-cluster-create -n $NAMESPACE >/dev/null 2>&1; then
            echo "ðŸ§¹ Removing existing redis-cluster-create job..."
            kubectl delete job redis-cluster-create -n $NAMESPACE --ignore-not-found=true
          fi

      - name: âš™ï¸ Pre-check StatefulSet compatibility
        run: |
          echo "ðŸ” Checking for immutable field changes in Redis StatefulSet..."
          if kubectl get statefulset redis -n $NAMESPACE >/dev/null 2>&1; then
            echo "âœ… Found existing redis StatefulSet. Checking for immutable spec changes..."
            kubectl get statefulset redis -n $NAMESPACE -o yaml > old_redis.yaml
            helm template hiteen $CHART_PATH -n $NAMESPACE > new_render.yaml

            if ! diff <(yq '.spec' old_redis.yaml) <(yq '.spec' new_render.yaml) | grep -Eq 'serviceName|volumeClaimTemplates|selector'; then
              echo "â„¹ï¸ No immutable field differences detected. Proceeding with Helm upgrade."
            else
              echo "âš ï¸ Immutable fields changed. Deleting existing StatefulSet redis to avoid Helm upgrade failure..."
              kubectl delete statefulset redis -n $NAMESPACE --cascade=orphan
              echo "âœ… Deleted old StatefulSet. Will be recreated by Helm."
            fi
          else
            echo "â„¹ï¸ No existing redis StatefulSet found. Proceeding with Helm install."
          fi
        shell: bash

      - name: ðŸª¶ Deploy via Helm
        run: |
          helm upgrade --install hiteen $CHART_PATH \
            -n $NAMESPACE \
            --set app.image.repository=$IMAGE \
            --set app.image.tag=$TAG \
            --set ingress.enabled=true \
            --wait --timeout 60s

      - name: ðŸ” Verify rollout
        run: |
          kubectl rollout status deployment/hiteen-test -n $NAMESPACE
          kubectl get pods -n $NAMESPACE -o wide

      - name: âœ… Success notification
        if: success()
        run: echo "âœ… hiteen deployed successfully!"

      - name: âŒ Failure notification
        if: failure()
        run: echo "âŒ Deployment failed. Check logs."
