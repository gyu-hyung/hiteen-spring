name: üöÄ Deploy to Kubernetes (Helm)

on:
  workflow_run:
    workflows: ["üèóÔ∏è Build & Push Docker Image"]
    types: [completed]
#on:
#  push:
#    branches: [ main ]

jobs:
  deploy:
    runs-on: [self-hosted]   # EC2 Runner (K8s ÌÅ¥Îü¨Ïä§ÌÑ∞ Ï†ëÍ∑º Í∞ÄÎä•)

    env:
      NAMESPACE: hiteen
      CHART_PATH: ./hiteen-chart
      IMAGE: ghcr.io/${{ github.repository_owner }}/hiteen-api
      TAG: ${{ github.event.workflow_run.head_sha }}
#      TAG: latest

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üîß Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: v1.30.0

      - name: üß∞ Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: üîê Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 --decode > ~/.kube/config
          chmod 600 ~/.kube/config
          kubectl config set-cluster kubernetes --insecure-skip-tls-verify=true
          echo "‚úÖ Current context:"
          kubectl config current-context
          kubectl get nodes -o wide

      - name: üß± Create namespace if not exists
        run: |
          kubectl get ns $NAMESPACE || kubectl create ns $NAMESPACE 

      - name: üîê Create Firebase Secret
        run: |
          echo "${{ secrets.FIREBASE_KEY_JSON }}" | base64 --decode > firebase-key.json
          kubectl delete secret firebase-secret -n $NAMESPACE --ignore-not-found
          kubectl create secret generic firebase-secret \
            --from-file=firebase-key.json=firebase-key.json \
            -n $NAMESPACE
          rm -f firebase-key.json
        shell: bash

      - name: üîê Create Redis Secret (Helm ownership ÎùºÎ≤®/Ïñ¥ÎÖ∏ÌÖåÏù¥ÏÖò Î∂ÄÏó¨)
        run: |
          REDIS_PASS="xxxxxxxx"
          kubectl delete secret redis-secret -n $NAMESPACE --ignore-not-found
          kubectl create secret generic redis-secret \
            --from-literal=redis-password=$REDIS_PASS \
            -n $NAMESPACE
          kubectl label secret redis-secret -n $NAMESPACE app.kubernetes.io/managed-by=Helm --overwrite
          kubectl annotate secret redis-secret -n $NAMESPACE meta.helm.sh/release-name=hiteen --overwrite
          kubectl annotate secret redis-secret -n $NAMESPACE meta.helm.sh/release-namespace=hiteen --overwrite
        shell: bash

      - name: üßπ Clean up pending Helm release
        run: |
          if helm status hiteen -n $NAMESPACE | grep -q "pending"; then
            echo "üîß Found pending release. Cleaning up..."
            helm uninstall hiteen -n $NAMESPACE || true
          fi

          if kubectl get job redis-cluster-create -n $NAMESPACE >/dev/null 2>&1; then
            echo "üßπ Removing existing redis-cluster-create job..."
            kubectl delete job redis-cluster-create -n $NAMESPACE --ignore-not-found=true
          fi

      - name: ü™∂ Deploy via Helm (App + Redis + soketi)
        run: |
          helm upgrade --install hiteen $CHART_PATH \
            -n $NAMESPACE \
            --set app.image.repository=$IMAGE \
            --set app.image.tag=$TAG \
            --set ingress.enabled=true \
            --set redis.enabled=true \
            --set redis.password=xxxxxxxx \
            --set redis.storageClass=local-path \
            --set redis.cluster.enabled=true \
            --wait --timeout 300s

      - name: ‚è≥ Wait for Redis StatefulSet to be Ready
        run: |
          echo "Waiting for Redis StatefulSet to be created..."
          for i in {1..30}; do
            if kubectl get statefulset redis -n $NAMESPACE >/dev/null 2>&1; then
              echo "‚úÖ Redis StatefulSet found. Waiting 3s to ensure registration..."
              sleep 3
              break
            fi
            echo "Redis StatefulSet not found yet... waiting 5s."
            sleep 5
          done
          
          echo "Waiting for Redis StatefulSet to be ready..."
          for i in {1..60}; do
            READY=$(kubectl get statefulset redis -n $NAMESPACE -o jsonpath='{.status.readyReplicas}')
            REPLICAS=$(kubectl get statefulset redis -n $NAMESPACE -o jsonpath='{.spec.replicas}')
            if [[ "$READY" == "$REPLICAS" && "$READY" != "" ]]; then
              echo "‚úÖ Redis StatefulSet is ready ($READY/$REPLICAS)."
              break
            fi
            echo "Redis not ready yet ($READY/$REPLICAS)... waiting 5s."
            sleep 5
          done

      - name: üîç Verify rollout
        run: |
          kubectl rollout status deployment/hiteen-test -n $NAMESPACE
          kubectl get pods -n $NAMESPACE -o wide

      - name: ‚úÖ Success notification
        if: success()
        run: echo "‚úÖ hiteen + redis-cluster deployed successfully!"

      - name: ‚ùå Failure notification
        if: failure()
        run: echo "‚ùå Deployment failed. Check logs."