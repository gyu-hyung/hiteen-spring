name: Deploy to Kubernetes (SmileServer)

on:
  workflow_run:
    workflows: ["Build & Push Docker Image"]
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: v1.30.0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 --decode > ~/.kube/config

      - name: Helm upgrade hiteen-api
        run: |
          IMAGE=ghcr.io/${{ github.repository_owner }}/hiteen-api
          TAG=${{ github.sha }}

          # Helm 설치 혹은 업데이트
          helm upgrade --install hiteen-api ./charts/api \
            -n hiteen-prod \
            --set image.repository=$IMAGE \
            --set image.tag=$TAG \
            --wait --timeout 300s

      - name: Verify deployment
        run: |
          kubectl get pods -n hiteen-prod
          kubectl rollout status deploy/hiteen-api -n hiteen-prod
