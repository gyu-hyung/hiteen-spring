name: Deploy to Kubernetes (SmileServer)

on:
  workflow_run:
    workflows: ["Build & Push Docker Image"]
    types: [completed]

jobs:
  deploy:
    runs-on: [self-hosted]

    env:
      NAMESPACE: hiteen-prod
      CHART_PATH: ./hiteen-api
      IMAGE: ghcr.io/${{ github.repository_owner }}/hiteen-api
      TAG: ${{ github.event.workflow_run.head_sha }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: v1.30.0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 --decode > ~/.kube/config
          chmod 600 ~/.kube/config
          kubectl config use-context $(kubectl config current-context)
          kubectl get nodes

      - name: Create namespace if not exists
        run: |
          kubectl get ns $NAMESPACE || kubectl create ns $NAMESPACE

      # ✅ main 브랜치 → prod / dev 브랜치 → dev
      - name: Helm upgrade (prod)
        if: github.ref_name == 'main'
        run: |
          helm upgrade --install hiteen-api $CHART_PATH \
            -n $NAMESPACE \
            --set image.repository=$IMAGE \
            --set image.tag=$TAG \
            --set env.PROFILE=prod \
            --wait --timeout 30s

      - name: Helm upgrade (dev)
        if: github.ref_name != 'main'
        run: |
          helm upgrade --install hiteen-api $CHART_PATH \
            -n $NAMESPACE \
            --set image.repository=$IMAGE \
            --set image.tag=$TAG \
            --set env.PROFILE=dev \
            --wait --timeout 300s

      - name: Verify deployment
        run: |
          kubectl rollout status deploy/hiteen-api -n $NAMESPACE
          kubectl get pods -n $NAMESPACE -o wide

      - name: Notify success
        if: success()
        run: echo "✅ hiteen-api deployed successfully to $NAMESPACE"

      - name: Notify failure
        if: failure()
        run: echo "❌ hiteen-api deploy failed. Check Helm/K8s logs."
