name: Deploy to Kubernetes (SmileServer)

on:
  workflow_run:
    workflows: ["Build & Push Docker Image"]
    types: [completed]

jobs:
  deploy:
    runs-on: [self-hosted]

    env:
      NAMESPACE: hiteen-prod
      CHART_PATH: ./charts/api
      IMAGE: ghcr.io/${{ github.repository_owner }}/hiteen-api
      TAG: ${{ github.event.workflow_run.head_sha }}

    steps:
      # 1ï¸âƒ£ ë¦¬í¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ ë””ë²„ê¹…ìš© (ì„ì‹œ)
      - name: Debug workspace (ì„ì‹œ í™•ì¸ìš©)
        run: |
          echo "í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬:"
          pwd
          echo "íŒŒì¼ ëª©ë¡:"
          ls -R .

      # 3ï¸âƒ£ kubectl & helm ì„¤ì¹˜
      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: v1.30.0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      # 4ï¸âƒ£ kubeconfig ì„¤ì •
      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 --decode > ~/.kube/config
          chmod 600 ~/.kube/config
          kubectl config use-context $(kubectl config current-context)
          echo "âœ… Current context:"
          kubectl config current-context
          kubectl get nodes -o wide

      # 5ï¸âƒ£ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„± (ì—†ìœ¼ë©´)
      - name: Create namespace if not exists
        run: |
          kubectl get ns $NAMESPACE || kubectl create ns $NAMESPACE

      # 6ï¸âƒ£ Firebase Secret ìƒì„± (ìë™)
      - name: Create firebase-secret
        run: |
          echo "${{ secrets.FIREBASE_KEY_JSON }}" > firebase-key.json
          kubectl create secret generic firebase-secret \
            -n $NAMESPACE \
            --from-file=firebase-key.json=firebase-key.json \
            --dry-run=client -o yaml | kubectl apply -f -
          echo "âœ… firebase-secret created/updated in namespace $NAMESPACE"

      # 7ï¸âƒ£ Helm ë°°í¬
      - name: Helm upgrade
        run: |
          helm upgrade --install hiteen-api $CHART_PATH \
            -n $NAMESPACE \
            --set image.repository=$IMAGE \
            --set image.tag=$TAG \
            --set env.PROFILE=dev \
            --wait --timeout 90s

      # 8ï¸âƒ£ ë°°í¬ ìƒíƒœ í™•ì¸
      - name: Verify deployment
        run: |
          kubectl rollout status deploy/hiteen-api -n $NAMESPACE
          kubectl get pods -n $NAMESPACE -o wide

      # 9ï¸âƒ£ ì„±ê³µ ì‹œ ë©”ì‹œì§€
      - name: Notify success
        if: success()
        run: echo "âœ… hiteen-api deployed successfully to $NAMESPACE"

      # ğŸ”Ÿ ì‹¤íŒ¨ ì‹œ ë©”ì‹œì§€
      - name: Notify failure
        if: failure()
        run: echo "âŒ hiteen-api deploy failed. Check Helm/K8s logs."
