name: ðŸ—ï¸ Build & Push Docker Image

#on:
#  workflow_dispatch
on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      # âœ… 1. Checkout
      - name: ðŸ§© Checkout source
        uses: actions/checkout@v4

      # âœ… 2. Cache Gradle dependencies
      - name: âš¡ Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # âœ… 3. Set up Docker Buildx
      - name: ðŸ§± Set up Buildx
        uses: docker/setup-buildx-action@v3

      # âœ… 4. Cache Docker Buildx layers
      - name: ðŸ—‚ï¸ Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      # âœ… 5. Log in to GitHub Container Registry
      - name: ðŸ” Log in to GHCR
        run: echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u ${{ github.repository_owner }} --password-stdin

      # âœ… 6. Build & Push (AMD64 only)
      - name: ðŸ—ï¸ Build & Push Docker image
        env:
          DOCKER_BUILDKIT: 1
        run: |
          IMAGE=ghcr.io/${{ github.repository_owner }}/hiteen-api
          TAG=${{ github.sha }}
          echo "ðŸš€ Building fast image: $IMAGE:$TAG"

          docker buildx build \
            --platform linux/amd64 \
            -t $IMAGE:$TAG -t $IMAGE:latest \
            --push \
            --cache-from type=local,src=/tmp/.buildx-cache \
            --cache-to type=local,dest=/tmp/.buildx-cache-new,mode=max .

      # âœ… 7. Persist new Docker cache
      - name: ðŸ’¾ Move updated Docker cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      # âœ… 8. Save built tag (sha) to file
      - name: ðŸ“„ Save built tag (sha) to file
        run: |
          echo "${{ github.sha }}" > build_tag.txt

      # âœ… 9. Upload build tag artifact
      - name: ðŸ“¦ Upload build tag artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-tag
          path: build_tag.txt

      # âœ… 10. Confirm success
      - name: âœ… Build complete
        if: success()
        run: echo "âœ… Fast AMD64 Docker image built & pushed successfully ðŸŽ‰"