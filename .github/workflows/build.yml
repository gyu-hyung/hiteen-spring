name: ğŸ—ï¸ Build & Push Docker Image

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      # 1ï¸âƒ£ Checkout
      - name: ğŸ§© Checkout source
        uses: actions/checkout@v4

      # 2ï¸âƒ£ JDK ì„¤ì • (ğŸ”¥ ì¤‘ìš”)
      - name: â˜• Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      # 3ï¸âƒ£ Gradle ìºì‹œ
      - name: âš¡ Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # 4ï¸âƒ£ âœ… Gradle Build (ğŸ”¥ í•µì‹¬)
      - name: ğŸ§ª Build with Gradle
        run: |
          chmod +x ./gradlew
          ./gradlew clean build -x test -Dspring.profiles.active=dev-k8s

      # 5ï¸âƒ£ Buildx
      - name: ğŸ§± Set up Buildx
        uses: docker/setup-buildx-action@v3

      # 6ï¸âƒ£ Docker layer cache
      - name: ğŸ—‚ï¸ Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      # 7ï¸âƒ£ GHCR Login
      - name: ğŸ” Log in to GHCR
        run: echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u ${{ github.repository_owner }} --password-stdin

      # 8ï¸âƒ£ Docker Build & Push
      - name: ğŸ—ï¸ Build & Push Docker image
        env:
          DOCKER_BUILDKIT: 1
        run: |
          IMAGE=ghcr.io/${{ github.repository_owner }}/hiteen-api
          TAG=${{ github.sha }}

          docker buildx build \
            --platform linux/amd64 \
            -t $IMAGE:$TAG \
            -t $IMAGE:latest \
            --push \
            --cache-from type=local,src=/tmp/.buildx-cache \
            --cache-to type=local,dest=/tmp/.buildx-cache-new,mode=max .

      # 9ï¸âƒ£ Cache persist
      - name: ğŸ’¾ Move updated Docker cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      # ğŸ”Ÿ Done
      - name: âœ… Build complete
        run: echo "âœ… Docker image built & pushed successfully ğŸ‰"
