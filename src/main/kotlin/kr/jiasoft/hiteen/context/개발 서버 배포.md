https://www.iwinv.kr/member/access/login.html

jiasoft / 06060515sjs!


ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx


í•˜ì´í‹´ ì„œë²„ ì •ë³´
- postgresql		49.247.175.76		root	xxxxxxxx	hiteen /  xxxxxxxx
- mongodb		49.247.170.182 	root	xxxxxxxx	hiteen /   xxxxxxxx
- api-1			49.247.170.21		root	xxxxxxxx
- api-2			49.247.170.115		root	xxxxxxxx
- lb			49.247.170.80

ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡


smile : http://49.247.170.80:8080/api/health

k8s : http://49.247.169.182:30080/api/health


docker buildx create --use                                                                    
docker buildx build \
--platform linux/amd64,linux/arm64 \
-t ghcr.io/gyu-hyung/hiteen-api:latest \
-t ghcr.io/gyu-hyung/hiteen-api:redis-fix \
--push .










ğŸš€ 1ï¸âƒ£ ë§ˆìŠ¤í„° ë…¸ë“œ(hiteen-api-1) ì ‘ì†

ssh root@49.247.170.21
ì´ ì„œë²„ê°€ Kubernetesì˜ Control Plane(ì¤‘ì•™ ê´€ë¦¬ì) ì—­í• ì„ í•˜ê²Œ ë©ë‹ˆë‹¤.

kubeadm join 10.8.3.69:6443 --token me98w4.gbgogvruezhihyfh \
--discovery-token-ca-cert-hash sha256:d6aeffbe70644c5f66753b87d297fb227285ade6d5e0d633676093eedf1660de

âš™ï¸ 2ï¸âƒ£ swap ë¹„í™œì„±í™”
KubernetesëŠ” swap(ê°€ìƒë©”ëª¨ë¦¬)ì„ ì‚¬ìš©í•˜ë©´ ì•ˆ ë¼ìš”.

swapoff -a
sed -i '/swap/d' /etc/fstab

ğŸ§© 3ï¸âƒ£ ë„¤íŠ¸ì›Œí¬ ì„¤ì •
ì»¨í…Œì´ë„ˆ ê°„ í†µì‹ ì„ ìœ„í•œ ì»¤ë„ ì„¤ì •ì´ì—ìš”.

cat <<EOF | tee /etc/modules-load.d/k8s.conf
overlay
br_netfilter
EOF

modprobe overlay
modprobe br_netfilter

cat <<EOF | tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-iptables=1
net.bridge.bridge-nf-call-ip6tables=1
net.ipv4.ip_forward=1
EOF

sysctl --system

ğŸ³ 4ï¸âƒ£ containerd ì„¤ì¹˜ (ì»¨í…Œì´ë„ˆ ëŸ°íƒ€ì„)

dnf install -y containerd
mkdir -p /etc/containerd
containerd config default | tee /etc/containerd/config.toml >/dev/null
Systemd cgroupìœ¼ë¡œ ë³€ê²½ (ì´ ì„¤ì •ì´ ì¤‘ìš”í•©ë‹ˆë‹¤)

sed -i 's/SystemdCgroup = false/SystemdCgroup = true/' /etc/containerd/config.toml
systemctl enable --now containerd

â˜¸ï¸ 5ï¸âƒ£ Kubernetes ì„¤ì¹˜

cat <<EOF > /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://pkgs.k8s.io/core:/stable:/v1.29/rpm/
enabled=1
gpgcheck=1
gpgkey=https://pkgs.k8s.io/core:/stable:/v1.29/rpm/repodata/repomd.xml.key
EOF

dnf install -y kubelet kubeadm kubectl
systemctl enable --now kubelet

ğŸŒ 6ï¸âƒ£ í´ëŸ¬ìŠ¤í„° ì´ˆê¸°í™”
ì´ì œ ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

kubeadm init --pod-network-cidr=192.168.0.0/16
ì„¤ì¹˜ê°€ ëë‚˜ë©´ ë§ˆì§€ë§‰ ì¤„ì¯¤ì—â€¨kubeadm join ... ì´ë¼ëŠ” ê¸´ ëª…ë ¹ì–´ê°€ ëœ¹ë‹ˆë‹¤.â€¨ğŸ‘‰ ê·¸ê±° ë³µì‚¬í•´ë‘ì„¸ìš”! (ì›Œì»¤ ë…¸ë“œë“¤ì´ í´ëŸ¬ìŠ¤í„°ì— ì¡°ì¸í•  ë•Œ ì‚¬ìš©)

ğŸª„ 7ï¸âƒ£ kubeconfig ì„¤ì •
ì´ ëª…ë ¹ì€ kubectl ëª…ë ¹ì–´ë¥¼ ì¼ë°˜ ì‚¬ìš©ìë„ ì“¸ ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤.

mkdir -p $HOME/.kube
cp /etc/kubernetes/admin.conf $HOME/.kube/config
chown $(id -u):$(id -g) $HOME/.kube/config

ğŸ•¸ï¸ 8ï¸âƒ£ Calico ì„¤ì¹˜ (Pod ë„¤íŠ¸ì›Œí¬)

curl -O https://raw.githubusercontent.com/projectcalico/calico/v3.27.3/manifests/calico.yaml
kubectl apply -f calico.yaml
Calicoê°€ ì„¤ì¹˜ë˜ë©´ ë„¤íŠ¸ì›Œí¬ê°€ ìë™ êµ¬ì„±ë©ë‹ˆë‹¤.â€¨í™•ì¸:

kubectl get pods -n kube-system
calico-node, calico-kube-controllers ê°€ Running ìƒíƒœë©´ OK âœ…

ğŸ”— 9ï¸âƒ£ ì›Œì»¤ ë…¸ë“œ ì—°ê²° ì¤€ë¹„
ë‹¤ë¥¸ ì„œë²„(api-2, redis-1, redis-2)ì—ì„œ í´ëŸ¬ìŠ¤í„°ì— ì¡°ì¸í•  ìˆ˜ ìˆë„ë¡ ëª…ë ¹ì„ ë³µì‚¬í•´ë‘¡ë‹ˆë‹¤.
ë§Œì•½ join ëª…ë ¹ì„ ê¹Œë¨¹ì—ˆìœ¼ë©´ ë‹¤ì‹œ í™•ì¸:

kubeadm token create --print-join-command

ì—¬ê¸°ê¹Œì§€ í•˜ë©´â€¨âœ… ë§ˆìŠ¤í„°(api-1) ë…¸ë“œ ì™„ì„±â€¨ì´ì œ ë‹¤ìŒ ë‹¨ê³„ëŠ” ì›Œì»¤ ë…¸ë“œ(api-2, redis-1, redis-2) ë¥¼ ë¶™ì´ëŠ” ê²ë‹ˆë‹¤.


kubeadm join 10.8.3.188:6443 --token lh61nc.iqu7zzggmlbz5osl --discovery-token-ca-cert-hash sha256:73aa24c434dccf2cc06b2d9a0ceaaa861f2d117fbaea999982c38fa46bb41af5



â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”ê° ì›Œì»¤ë…¸ë“œ ì„¤ì •




ğŸ§© â‘  swap ë„ê¸°

swapoff -a
sed -i '/swap/d' /etc/fstab


ğŸ§© â‘¡ ì»¤ë„ ì„¤ì •

cat <<EOF | tee /etc/modules-load.d/k8s.conf
overlay
br_netfilter
EOF
modprobe overlay
modprobe br_netfilter

cat <<EOF | tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-iptables=1
net.bridge.bridge-nf-call-ip6tables=1
net.ipv4.ip_forward=1
EOF
sysctl --system


ğŸ§© â‘¢ containerd ì„¤ì¹˜ ì—ëŸ¬ ì‹œ ì•„ë˜ ì°¸ì¡°

dnf config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
dnf install -y containerd.io

mkdir -p /etc/containerd
containerd config default | tee /etc/containerd/config.toml >/dev/null
sed -i 's/SystemdCgroup = false/SystemdCgroup = true/' /etc/containerd/config.toml
systemctl enable --now containerd

systemctl status containerd


ğŸ§© â‘£ Kubernetes ì„¤ì¹˜

cat <<EOF > /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://pkgs.k8s.io/core:/stable:/v1.29/rpm/
enabled=1
gpgcheck=1
gpgkey=https://pkgs.k8s.io/core:/stable:/v1.29/rpm/repodata/repomd.xml.key
EOF

dnf install -y kubelet kubeadm kubectl
systemctl enable --now kubelet


âš™ï¸ 4ï¸âƒ£ í´ëŸ¬ìŠ¤í„°ì— ì¡°ì¸ (join ëª…ë ¹ ì‹¤í–‰)
ì•„ê¹Œ ë§ˆìŠ¤í„°ì—ì„œ ë³µì‚¬í•œ ëª…ë ¹ì–´ë¥¼ ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš” ğŸ‘‡â€¨(ì˜ˆì‹œ)

kubeadm join 49.247.170.21:6443 --token abcdef.0123456789abcdef \
--discovery-token-ca-cert-hash sha256:112233445566778899...
ì´ê±¸ api-2, redis-1, redis-2 ì„¸ ì„œë²„ì— ê°ê° ì‹¤í–‰í•©ë‹ˆë‹¤.

âœ… 5ï¸âƒ£ ë§ˆìŠ¤í„°ì—ì„œ í™•ì¸
ë‹¤ì‹œ hiteen-api-1 (ë§ˆìŠ¤í„°)ë¡œ ëŒì•„ì™€ì„œ í™•ì¸:

kubectl get nodes -o wide
ì •ìƒì´ë¼ë©´ ì•„ë˜ì²˜ëŸ¼ í‘œì‹œë©ë‹ˆë‹¤ ğŸ‘‡

NAME              STATUS   ROLES           AGE   VERSION   INTERNAL-IP




hiteen-api-1      Ready    control-plane   10m   v1.29.x   49.247.170.21
hiteen-api-2      Ready    <none>          2m    v1.29.x   49.247.170.115
hiteen-redis-1    Ready    <none>          2m    v1.29.x   49.247.171.15
hiteen-redis-2    Ready    <none>          2m    v1.29.x   49.247.172.156
ğŸ‰ ëª¨ë“  ë…¸ë“œê°€ STATUS=Ready ë©´ ì„±ê³µì…ë‹ˆë‹¤!


ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡
helm ì„¤ì¹˜ hiteen-chart ì„¸íŒ…ğŸ˜



kubectl create ns hiteen

kubectl create secret docker-registry ghcr-secret   --docker-server=ghcr.io   --docker-username=gyu-hyung   --docker-password=ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx   -n hiteen


kubectl exec -it redis-0 -n hiteen -- redis-cli -a xxxxxxxx cluster info


helm upgrade --install hiteen $CHART_PATH \
-n $NAMESPACE \
--set app.image.repository=$IMAGE \
--set app.image.tag=$TAG \
--set ingress.enabled=true \
--set redis.enabled=true \
--set redis.password=xxxxxxxx \
--set redis.storageClass=local-path \
--set redis.cluster.enabled=true








ğŸ‘‰ local-path-provisioner ë‹¤ì‹œ ì„¤ì¹˜
1ï¸âƒ£ local-path-storage ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„±
kubectl create ns local-path-storage





2ï¸âƒ£ ê³µì‹ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì ìš©
kubectl apply -f https://raw.githubusercontent.com/rancher/local-path-provisioner/master/deploy/local-path-storage.yaml

3ï¸âƒ£ ì •ìƒ ì—¬ë¶€ í™•ì¸
kubectl get pods -n local-path-storage




1ï¸âƒ£ ingress-nginx ì™„ì „ ì¬ì„¤ì¹˜ (í•„ìˆ˜)






















kubectl -n ingress-nginx edit svc ingress-nginx-controller





â€”
kubectl delete statefulset redis -n hiteen

kubectl delete pvc -n hiteen -l app=redis

4redis ì²´í¬




calico ì„¤ì¹˜







kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.2/manifests/calico.yaml













