# ============================================================================================
# 클러스터 초기화
# ============================================================================================

# ============= 서비스 삭제 ==========

# helm 으로 올린것 내리기
helm uninstall hiteen -n hiteen

#애플리케이션 네임스페이스 제거
kubectl delete ns hiteen

#확인
kubectl get ns

#pv 등 안지워지면
kubectl patch pv nfs-pv-backup -p '{"metadata":{"finalizers":null}}'
kubectl patch pv nfs-pv-images -p '{"metadata":{"finalizers":null}}'
kubectl delete pv nfs-pv-backup
kubectl delete pv nfs-pv-images


#그래도 ns 삭제가 안되면 finalizers => 빈 배열로[]
kubectl get namespace hiteen -o json > hiteen-ns.json

# spec.finalizers / metadata.finalizers 전부 []
vi hiteen-ns.json


"spec": {
"finalizers": [
"kubernetes"
]
}

"spec": {
"finalizers": []
}


#적용
kubectl replace --raw "/api/v1/namespaces/hiteen/finalize" -f hiteen-ns.json

#확인
kubectl get ns



# ============= local-path-storage 삭제 ==========
# ============= INGRESS 삭제 ==========

#Webhook 목록 확인
kubectl get validatingwebhookconfiguration | grep ingress

#Webhook 삭제
kubectl delete validatingwebhookconfiguration ingress-nginx-admission


#그래도 ns 삭제가 안되면 finalizers => 빈 배열로[]
kubectl get namespace ingress-nginx -o json > ingress-nginx.json

# spec.finalizers / metadata.finalizers 전부 []
vi ingress-nginx.json

#적용
kubectl replace --raw "/api/v1/namespaces/ingress-nginx/finalize" -f ingress-nginx.json

#확인
kubectl get ns


# ============= local-path-storage 삭제 ==========


# local-path-provisioner 제거
kubectl delete namespace local-path-storage

#StorageClass 삭제 (중요) local-path는 네임스페이스 삭제로 안 없어짐
kubectl delete storageclass local-path



# 
kubectl get namespace local-path-storage -o json > local-path.json
vi local-path.json
kubectl replace --raw "/api/v1/namespaces/local-path-storage/finalize" -f local-path.json

# 확인
kubectl get storageclass



PVC/PV 정리 (남아 있으면)
kubectl get pv
kubectl delete pv <pv-name>





# 모두 확인
kubectl get all -A


# 다시확인
kubectl get pv -A
kubectl get pvc -A
kubectl get statefulset -A
kubectl get storageclass -A




















# ============================================================================================
# 배포
# ============================================================================================

# hiteen ns & secret
kubectl create ns hiteen
kubectl create secret docker-registry ghcr-secret   --docker-server=ghcr.io   --docker-username=gyu-hyung   --docker-password=ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx   -n hiteen



# redis local-path-storage
kubectl create ns local-path-storage
kubectl apply -f https://raw.githubusercontent.com/rancher/local-path-provisioner/master/deploy/local-path-storage.yaml



# ingress
kubectl create namespace ingress-nginx || true
kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.11.3/deploy/static/provider/baremetal/deploy.yaml



# github action push 로 helm 배포 첫 배포시 실패?


# redis cluster 로 묶기
kubectl exec -it -n hiteen redis-0 -- redis-cli -a xxxxxxxx --cluster create \
redis-0.redis.hiteen.svc.cluster.local:6379 \
redis-1.redis.hiteen.svc.cluster.local:6379 \
redis-2.redis.hiteen.svc.cluster.local:6379 \
redis-3.redis.hiteen.svc.cluster.local:6379 \
redis-4.redis.hiteen.svc.cluster.local:6379 \
redis-5.redis.hiteen.svc.cluster.local:6379 \
--cluster-replicas 0



# redis cluster 확인
kubectl exec -n hiteen redis-0 -- redis-cli -a xxxxxxxx cluster info
kubectl exec -n hiteen redis-0 -- redis-cli -a xxxxxxxx cluster nodes




