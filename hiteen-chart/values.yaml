# ============================================
# Global Settings
# ============================================
namespace: hiteen

nodeSelector:
  node-type: private

imagePullSecrets:
  - name: gitlab-registry-secret

# ============================================
# Backend (Spring Boot)
# ============================================
app:
  fullnameOverride: hiteen-test
  name: hiteen-test
  replicaCount: 1

  image:
    repository: gitlab.barunsoft.net:5050/jiasoft/hiteen2-server
    tag: latest
    pullPolicy: Always

  service:
    type: ClusterIP
    port: 8080

  env:
    - name: SPRING_PROFILES_ACTIVE
      value: dev-k8s

    - name: REDIS_HOST
      value: redis-0.redis.hiteen.svc.cluster.local
    - name: REDIS_PORT
      value: "6379"
    - name: REDIS_PASSWORD
      valueFrom:
        secretKeyRef:
          name: redis-secret
          key: redis-password

    - name: FIREBASE_CREDENTIAL_PATH
      value: /app/firebase/firebase-key.json

    # ğŸ”¥ JVM ë©”ëª¨ë¦¬ ëª…ì‹œ (ì¤‘ìš”)
    - name: JAVA_TOOL_OPTIONS
      # ì»¨í…Œì´ë„ˆ ë©”ëª¨ë¦¬ limit(3Gi) ê¸°ì¤€ìœ¼ë¡œ í™ 2Gi + ë„¤ì´í‹°ë¸Œ/ë©”íƒ€ìŠ¤í˜ì´ìŠ¤ ì—¬ìœ  í™•ë³´
      value: "-Xms512m -Xmx2048m -XX:+UseG1GC -XX:+ExitOnOutOfMemoryError -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/tmp"

  # ğŸ”¥ ë¦¬ì†ŒìŠ¤ ìƒí–¥ (OOM ë°©ì§€)
  resources:
    requests:
      cpu: 300m
      memory: 1Gi
    limits:
      cpu: 1
      memory: 3Gi

  # ============================================
  # Health Probes (ì•ˆì •í™” í•µì‹¬)
  # ============================================
  startupProbe:
    httpGet:
      path: /actuator/health
      port: 8080
    failureThreshold: 30   # ìµœëŒ€ 150ì´ˆ ëŒ€ê¸°
    periodSeconds: 5

  livenessProbe:
    httpGet:
      path: /actuator/health/liveness
      port: 8080
    initialDelaySeconds: 60
    timeoutSeconds: 3
    periodSeconds: 10
    failureThreshold: 3

  readinessProbe:
    httpGet:
      path: /actuator/health/readiness
      port: 8080
    initialDelaySeconds: 30
    timeoutSeconds: 3
    periodSeconds: 5
    failureThreshold: 3



# ============================================
# admin
# ============================================
admin:
  enabled: true
  replicaCount: 1
  image:
    repository: ghcr.io/gyu-hyung/hiteen-admin
    tag: manual-20251229-1515
    pullPolicy: IfNotPresent


# ============================================
# NFS (Assets)
# ============================================
nfs:
  server: "10.8.0.159"
  path: "/srv/nfs/assets"
  storage: "100Gi"

backupNfs:
  server: "10.8.0.159"
  path: "/srv/nfs/assets"
  storage: "50Gi"


# ============================================
# Redis Cluster
# ============================================
redis:
  replicas: 6
  clusterReplicas: 1
  password: "xxxxxxxx"

  image:
    repository: redis
    tag: "7.2"
    pullPolicy: IfNotPresent

  service:
    name: redis
    port: 6379
    clusterPort: 16379

  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 300m
      memory: 256Mi

  storageClass: local-path
  storageSize: 2Gi
  accessModes:
    - ReadWriteOnce

  # âœ… Cluster init jobì´ ì‚¬ìš©í•  ê°’ë“¤ ëª…ì‹œ (Job ë‚´ì—ì„œ ì‚¬ìš©ë¨)
  clusterInit:
    enabled: true
    waitTimeout: 80          # Redis pod ì¤€ë¹„ ëŒ€ê¸° ì‹œê°„ (ì´ˆ)
    pingInterval: 3           # ping ì¬ì‹œë„ ê°„ê²© (ì´ˆ)
    namespace: hiteen         # í´ëŸ¬ìŠ¤í„° ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì§€ì • (ë³€ìˆ˜ ì£¼ì…)

# ============================================
# Ingress (Nginx)
# ============================================
ingress:
  enabled: true
  className: nginx
  annotations:
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/client-max-body-size: "50m"
    nginx.ingress.kubernetes.io/websocket-services: "hiteen-test"

  hosts:
    - host: dev.hiteen.co.kr
      paths:
        - path: /
          pathType: Prefix
          backend:
            serviceName: hiteen-test
            servicePort: 8080

# ============================================
# Metrics (Prometheus Operator)
# ============================================
metrics:
  enabled: true

  serviceMonitor:
    enabled: true
    # kube-prometheus-stackê°€ ì„¤ì¹˜ëœ ë„¤ì„ìŠ¤í˜ì´ìŠ¤
    namespace: monitoring
    # kube-prometheus-stack ê¸°ë³¸ selectorëŠ” ë³´í†µ release ë ˆì´ë¸” ê¸°ì¤€ì…ë‹ˆë‹¤.
    # ì„¤ì¹˜ ì‹œ ë¦´ë¦¬ìŠ¤ëª…ì„ ë¬´ì—‡ìœ¼ë¡œ í–ˆëŠ”ì§€ì— ë§ì¶° ë³€ê²½í•˜ì„¸ìš”.
    releaseLabel: monitoring

    interval: 15s
    scrapeTimeout: 10s
    path: /actuator/prometheus

    honorLabels: true
