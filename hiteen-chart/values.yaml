# ============================================
# Global Settings
# ============================================
namespace: hiteen

nodeSelector:
  node-type: private

imagePullSecrets:
  - name: ghcr-secret

# ============================================
# Backend (Spring Boot)
# ============================================
app:
  fullnameOverride: hiteen-test
  name: hiteen-test
  replicaCount: 1
  image:
    repository: ghcr.io/gyu-hyung/hiteen-api
    tag: latest
    pullPolicy: Always
  service:
    type: ClusterIP
    port: 8080
  env:
    - name: SPRING_PROFILES_ACTIVE
      value: dev-k8s
    - name: REDIS_HOST
      value: redis-0.redis.hiteen.svc.cluster.local
    - name: REDIS_PORT
      value: "6379"
    - name: REDIS_PASSWORD
      valueFrom:
        secretKeyRef:
          name: redis-secret
          key: redis-password
    - name: FIREBASE_CREDENTIAL_PATH
      value: /app/firebase/firebase-key.json
  resources:
    requests:
      cpu: 300m
      memory: 512Mi
    limits:
      cpu: 1
      memory: 1Gi

# ============================================
# NFS (Assets)
# ============================================
nfs:
  server: "10.8.0.159"
  path: "/srv/nfs/assets"
  storage: "100Gi"

backupNfs:
  server: "10.8.0.159"
  path: "/srv/nfs/assets"
  storage: "50Gi"

# ============================================
# Soketi
# ============================================
soketi:
  name: soketi
  replicaCount: 1
  image:
    repository: quay.io/soketi/soketi
    tag: 1.4-16-debian
    pullPolicy: Always

  service:
    name: soketi-svc
    type: ClusterIP
    port: 6001

  env:
    - name: DEFAULT_APP_ID
      value: "hiteen-app"
    - name: DEFAULT_APP_KEY
      value: "hiteen-key"
    - name: DEFAULT_APP_SECRET
      value: "hiteen-secret"
    - name: HOST
      value: "0.0.0.0"
    - name: PORT
      value: "6001"
    - name: DEBUG
      value: "1"

    # Redis Cluster adapter
    - name: ADAPTER_DRIVER
      value: "redis"
    - name: REDIS_HOST
      value: "redis-0.redis.hiteen.svc.cluster.local"
    - name: REDIS_PORT
      value: "6379"
    - name: REDIS_PASSWORD
      valueFrom:
        secretKeyRef:
          name: redis-secret
          key: redis-password

    - name: CORS_ALLOW_ORIGIN
      value: "*"
    - name: CLIENT_MESSAGES_ENABLED
      value: "true"

# ============================================
# Redis Cluster
# ============================================
redis:
  replicas: 6
  clusterReplicas: 1
  password: "xxxxxxxx"

  image:
    repository: redis
    tag: "7.2"
    pullPolicy: IfNotPresent

  service:
    name: redis
    port: 6379
    clusterPort: 16379

  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 300m
      memory: 256Mi

  storageClass: local-path
  storageSize: 2Gi
  accessModes:
    - ReadWriteOnce

  # âœ… Cluster init jobì´ ì‚¬ìš©í•  ê°’ë“¤ ëª…ì‹œ (Job ë‚´ì—ì„œ ì‚¬ìš©ë¨)
  clusterInit:
    enabled: true
    waitTimeout: 80          # Redis pod ì¤€ë¹„ ëŒ€ê¸° ì‹œê°„ (ì´ˆ)
    pingInterval: 3           # ping ì¬ì‹œë„ ê°„ê²© (ì´ˆ)
    namespace: hiteen         # í´ëŸ¬ìŠ¤í„° ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì§€ì • (ë³€ìˆ˜ ì£¼ì…)

# ============================================
# Ingress (Nginx)
# ============================================
ingress:
  enabled: true
  className: nginx
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: "/"
    nginx.ingress.kubernetes.io/ssl-redirect: "false"

    # âœ… ì—…ë¡œë“œ ìš©ëŸ‰ ì œí•œ í•´ê²° (í•„ìˆ˜)
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/client-max-body-size: "50m"

    nginx.ingress.kubernetes.io/proxy-buffering: "on"
    nginx.ingress.kubernetes.io/proxy-cache: "assets-cache"
    nginx.ingress.kubernetes.io/proxy-cache-key: "$request_uri"
    nginx.ingress.kubernetes.io/proxy-cache-valid: "200 1d"


    # ë¬´ì¤‘ë‹¨
    nginx.ingress.kubernetes.io/service-upstream: "true"

    # ğŸš€ ì¥ì• ì‹œ ì¬ì‹œë„ (ìƒˆ Pod ì¤€ë¹„ë  ë•Œê¹Œì§€ ì„œë¹„ìŠ¤ê°€ fallback ì²˜ë¦¬)
    nginx.ingress.kubernetes.io/proxy-next-upstream: "error timeout http_502 http_503 http_504"
    nginx.ingress.kubernetes.io/proxy-next-upstream-tries: "5"

    # ğŸ”¥ WebSocket ì•ˆì •ì„± í•µì‹¬
    nginx.ingress.kubernetes.io/websocket-services: "hiteen-test"
    nginx.ingress.kubernetes.io/connection-proxying: "on"

    # ğŸ”¥ Idle timeout í•´ê²°
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "10"



  hosts:
    - host: api.hiteen.co.kr     # â­ ì—¬ê¸° ì¶”ê°€!
      paths:
        - path: /
          pathType: Prefix
          backend:
            serviceName: hiteen-test
            servicePort: 8080

        - path: /grafana
          pathType: Prefix
          backend:
            serviceName: prometheus-grafana
            servicePort: 80

        - path: /prometheus
          pathType: Prefix
          backend:
            serviceName: prometheus-kube-prometheus-prometheus
            servicePort: 9090
