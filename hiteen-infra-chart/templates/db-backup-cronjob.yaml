{{- if .Values.dbBackup.enabled }}
apiVersion: v1
kind: Secret
metadata:
  name: postgres-backup-secret
  namespace: {{ .Values.namespace }}
type: Opaque
data:
  postgres-password: {{ .Values.dbBackup.postgres.password | b64enc }}

---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: postgres-backup
  namespace: {{ .Values.namespace }}
spec:
  schedule: "{{ .Values.dbBackup.schedule }}"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          nodeSelector:
            {{- toYaml .Values.nodeSelector | nindent 12 }}
          containers:
            - name: db-backup
              image: postgres:16
              env:
                - name: PGPASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: postgres-backup-secret
                      key: postgres-password
                - name: PG_HOST
                  value: "{{ .Values.dbBackup.postgres.host }}"
                - name: PG_USER
                  value: "{{ .Values.dbBackup.postgres.user }}"
                - name: PG_DATABASE
                  value: "{{ .Values.dbBackup.postgres.database }}"
                - name: RETENTION_DAYS
                  value: "{{ .Values.dbBackup.retention.days }}"
              command:
                - /bin/bash
                - -c
                - |
                  set -e
                  TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
                  BACKUP_FILE="/backup/hiteen-prod-${TIMESTAMP}.dump"
                  
                  echo "ðŸš€ Starting backup at ${TIMESTAMP}"
                  echo "ðŸ“¦ Database: ${PG_DATABASE}"
                  
                  # Full database backup
                  pg_dump -h ${PG_HOST} -U ${PG_USER} -d ${PG_DATABASE} -F c -f ${BACKUP_FILE}
                  
                  if [ -f "${BACKUP_FILE}" ]; then
                    SIZE=$(du -h ${BACKUP_FILE} | cut -f1)
                    echo "âœ… Backup completed: ${BACKUP_FILE} (${SIZE})"
                  else
                    echo "âŒ Backup failed!"
                    exit 1
                  fi
                  
                  # Cleanup old backups
                  echo "ðŸ§¹ Cleaning up backups older than ${RETENTION_DAYS} days..."
                  find /backup -name "hiteen-prod-*.dump" -mtime +${RETENTION_DAYS} -delete
                  
                  echo "ðŸ“‹ Current backups:"
                  ls -lh /backup/*.dump 2>/dev/null || echo "No backups found"
              volumeMounts:
                - name: nfs-backup
                  mountPath: /backup
          volumes:
            - name: nfs-backup
              persistentVolumeClaim:
                claimName: nfs-pvc-backup
{{- end }}

