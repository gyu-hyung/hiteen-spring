{{- if .Values.assetBackup.enabled }}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: asset-backup
  namespace: {{ .Values.namespace }}
spec:
  schedule: "{{ .Values.assetBackup.schedule }}"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          {{- with .Values.nodeSelector }}
          nodeSelector:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          containers:
            - name: asset-backup
              image: alpine:3.19
              env:
                - name: RETENTION_DAYS
                  value: "{{ .Values.assetBackup.retention.days }}"
              command:
                - /bin/sh
                - -c
                - |
                  set -e
                  apk add --no-cache rsync tar gzip
                  
                  TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
                  BACKUP_DIR="/backup/assets"
                  BACKUP_FILE="${BACKUP_DIR}/assets-${TIMESTAMP}.tar.gz"
                  
                  echo "ðŸš€ Starting asset backup at ${TIMESTAMP}"
                  
                  # Create backup directory if not exists
                  mkdir -p ${BACKUP_DIR}
                  
                  # Create compressed backup
                  echo "ðŸ“¦ Creating compressed backup..."
                  tar -czf ${BACKUP_FILE} -C /assets .
                  
                  if [ -f "${BACKUP_FILE}" ]; then
                    SIZE=$(du -h ${BACKUP_FILE} | cut -f1)
                    echo "âœ… Asset backup completed: ${BACKUP_FILE} (${SIZE})"
                  else
                    echo "âŒ Asset backup failed!"
                    exit 1
                  fi
                  
                  # Cleanup old backups
                  echo "ðŸ§¹ Cleaning up asset backups older than ${RETENTION_DAYS} days..."
                  find ${BACKUP_DIR} -name "assets-*.tar.gz" -mtime +${RETENTION_DAYS} -delete
                  
                  echo "ðŸ“‹ Current asset backups:"
                  ls -lh ${BACKUP_DIR}/*.tar.gz 2>/dev/null || echo "No backups found"
                  
                  # Show total backup size
                  echo "ðŸ“Š Total backup storage used:"
                  du -sh /backup/*
              volumeMounts:
                - name: nfs-assets
                  mountPath: /assets
                  readOnly: true
                - name: nfs-backup
                  mountPath: /backup
          volumes:
            - name: nfs-assets
              persistentVolumeClaim:
                claimName: {{ .Values.nfs.pvcName }}
            - name: nfs-backup
              persistentVolumeClaim:
                claimName: nfs-pvc-backup
{{- end }}
