# ============================================
# Global Settings - Production
# ============================================
namespace: hiteen

# nodeSelector 비활성화 (단일 노드 운영)
# nodeSelector:
#   node-type: private

imagePullSecrets:
  - name: gitlab-registry

# NFS Storage (hiteen-infra-chart에서 PV/PVC 생성, 여기서는 참조만)
nfs:
  enabled: true  # Pod에서 NFS 마운트 활성화
  createPV: false  # PV/PVC는 infra-chart에서 생성
  pvcName: nfs-pvc-images  # 참조할 PVC 이름

# ============================================
# Backend Application (Spring Boot)
# ============================================
app:
  name: hiteen-api
  replicaCount: 1  # 초기 배포는 1개로 시작

  image:
    repository: gitlab.barunsoft.net:6005/jiasoft/hiteen2-server  # GitLab Registry (HTTPS)
    tag: prod-0.0.1
    pullPolicy: Always

  service:
    type: ClusterIP
    port: 8080

  env:
    - name: SPRING_PROFILES_ACTIVE
      value: prod

    # Database
    - name: DB_HOST
      valueFrom:
        secretKeyRef:
          name: hiteen-app-secret
          key: db-host

    - name: DB_NAME
      valueFrom:
        secretKeyRef:
          name: hiteen-app-secret
          key: db-name

    - name: DB_USER
      valueFrom:
        secretKeyRef:
          name: hiteen-app-secret
          key: db-user

    - name: DB_PASSWORD
      valueFrom:
        secretKeyRef:
          name: hiteen-app-secret
          key: db-password


    # MongoDB
    - name: MONGO_HOST
      valueFrom:
        secretKeyRef:
          name: hiteen-app-secret
          key: mongo-host

    - name: MONGO_USER
      valueFrom:
        secretKeyRef:
          name: hiteen-app-secret
          key: mongo-user

    - name: MONGO_PASSWORD
      valueFrom:
        secretKeyRef:
          name: hiteen-app-secret
          key: mongo-password

    - name: MONGO_DB
      valueFrom:
        secretKeyRef:
          name: hiteen-app-secret
          key: mongo-db


    # Redis
    - name: REDIS_PASSWORD
      valueFrom:
        secretKeyRef:
          name: redis-secret
          key: redis-password


    # JWT
    - name: JWT_SECRET
      valueFrom:
        secretKeyRef:
          name: hiteen-app-secret
          key: jwt-secret


    - name: FIREBASE_CREDENTIAL_PATH
      value: /app/firebase/firebase-key.json

    # JVM Settings (Memory Limit 4Gi 기준, 힙은 약 60-70% 할당)
    # -Xms: 초기 힙 (빠른 시작을 위해 낮게 설정)
    # -Xmx: 최대 힙 (Limit의 약 65%, 나머지는 Metaspace/Native용)
    # -XX:MaxMetaspaceSize: Metaspace 제한으로 OOM 방지
    # -XX:MaxDirectMemorySize: Direct Buffer 제한
    - name: JAVA_TOOL_OPTIONS
      value: "-Xms512m -Xmx2560m -XX:MaxMetaspaceSize=300m -XX:MaxDirectMemorySize=300m -XX:+UseG1GC -XX:+ExitOnOutOfMemoryError -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/tmp -Duser.timezone=Asia/Seoul"

  # Resources
  resources:
    requests:
      cpu: 1
      memory: 2Gi
    limits:
      cpu: 2
      memory: 4Gi

  # Health Probes
  startupProbe:
    httpGet:
      path: /actuator/health
      port: 8080
    failureThreshold: 30
    periodSeconds: 5

  livenessProbe:
    httpGet:
      path: /actuator/health/liveness
      port: 8080
    initialDelaySeconds: 60
    timeoutSeconds: 5
    periodSeconds: 10
    failureThreshold: 3

  readinessProbe:
    httpGet:
      path: /actuator/health/readiness
      port: 8080
    initialDelaySeconds: 30
    timeoutSeconds: 5
    periodSeconds: 5
    failureThreshold: 3

  # Pod Disruption Budget
  pdb:
    enabled: false
    minAvailable: 1

  # Horizontal Pod Autoscaler - 나중에 활성화
  hpa:
    enabled: false
    minReplicas: 2
    maxReplicas: 5
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80

# ============================================
# Ingress (Nginx) - Production
# ============================================
ingress:
  enabled: true
  className: nginx
  annotations:
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/client-max-body-size: "50m"
    nginx.ingress.kubernetes.io/websocket-services: "hiteen-api"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"

  hosts:
    - host: api.hiteen.kr  # 운영 도메인
      paths:
        - path: /
          pathType: Prefix
          backend:
            serviceName: hiteen-api
            servicePort: 8080

  tls:
    - secretName: hiteen-api-tls
      hosts:
        - api.hiteen.kr
        - "*.hiteen.kr"

# ============================================
# Metrics (Prometheus) - 나중에 활성화
# ============================================
metrics:
  enabled: false
  serviceMonitor:
    enabled: false
    namespace: monitoring
    releaseLabel: monitoring
    interval: 15s
    scrapeTimeout: 10s
    path: /actuator/prometheus
    honorLabels: true

# ============================================
# Secrets 관리 방법
# ============================================
# Secret은 deploy-prod.sh에서 kubectl로 별도 생성합니다.
# Helm chart에서는 secretKeyRef로 참조만 합니다.
#
# 생성된 Secret:
#   - hiteen-app-secret: DB, Mongo, JWT 등 앱 설정
#   - redis-secret: Redis 비밀번호
#   - firebase-secret: Firebase 인증 키
#   - gitlab-registry: GitLab Container Registry 인증
#
# Secret 수정 방법:
#   kubectl edit secret hiteen-app-secret -n hiteen-prod
